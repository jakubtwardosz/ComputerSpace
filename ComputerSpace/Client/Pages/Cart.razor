@page "/cart"
@inject ICartService CartService
@inject IOrderService OrderService
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<PageTitle>Cart</PageTitle>

<MudContainer Class="mt-16" MaxWidth="MaxWidth.Medium">
    <MudText Typo="Typo.h3" Align="Align.Center" GutterBottom="true">Cart</MudText>

    @if (cartProducts == null || cartProducts.Count == 0)
    {
        <MudText Align="Align.Center">@message</MudText>
    }
    else
    {
        <MudSimpleTable Style="overflow-x: auto;" Class="mt-16" Elevation="1" Dense="true">
            <thead>
                <tr>

                    <th>Image</th>
                    <th>Product name</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var product in cartProducts)
                {
                    <tr>

                        <td><MudImage Src="@product.ImageUrl" Width="154" Height="133" Elevation="0" /></td>
                        <td>
                            <a href="/product/@product.ProductId"><MudText>@product.Title</MudText></a>
                            <MudText>@product.ProductType</MudText>
                        </td>
                        <td><MudText>@(product.Price * product.Quantity) zł</MudText></td>
                        <td>
                            <input type="number" value="@product.Quantity" class="input-quantity"
                           @onchange="@((ChangeEventArgs e) => UpdateQuantity(e, product))"
                           min="1" />
                        </td>
                        <td>
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" @onclick="@(() => RemoveProductFromCart(product.ProductId, product.ProductTypeId))" Variant="Variant.Filled" DisableElevation="true" Color="Color.Error" Size="Size.Small" />
                        </td>
                    </tr>
                }
            </tbody>
        </MudSimpleTable>

        <MudGrid Class="mt-8">
            <MudItem xs="12">
                <MudText Typo="Typo.h6" Align="Align.End">Total price (@cartProducts.Count): @cartProducts.Sum(product => @product.Price * product.Quantity) zł</MudText>
            </MudItem>
            @if (isAuthenticated)
            {
                <MudItem xs="12">
                    <MudText Typo="Typo.h5" GutterBottom="true">Delivery Address</MudText>
                    <AddressForm />
                </MudItem>
            }
            <MudItem xs="12" Class="d-flex justify-end">
                <MudButton @onclick="PlaceOrder" Variant="Variant.Filled" DisableElevation="true" Color="Color.Primary" Size="Size.Large" Class="mt-8">Checkout</MudButton>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    List<CartProductResponse> cartProducts = null;
    string message = "Loading cart...";
    bool isAuthenticated = false;

    protected override async Task OnInitializedAsync()
    {
        isAuthenticated = await AuthService.IsUserAuthenticated();
        await LoadCart();
    }

    private async Task RemoveProductFromCart(int productId, int productTypeId)
    {
        await CartService.RemoveProductFromCart(productId, productTypeId);
        await LoadCart();
    }

    private async Task LoadCart()
    {
        await CartService.GetCartItemsCount();
        cartProducts = await CartService.GetCartProducts();

        if (cartProducts == null || cartProducts.Count == 0)
        {
            message = "Your cart is empty.";
        }
    }

    private async Task UpdateQuantity(ChangeEventArgs e, CartProductResponse product)
    {
        product.Quantity = int.Parse(e.Value.ToString());
        if (product.Quantity < 1)
            product.Quantity = 1;
        await CartService.UpdateQuantity(product);
    }

    private async Task PlaceOrder()
    {
        string url = await OrderService.PlaceOrder();
        NavigationManager.NavigateTo(url);
    }
}
